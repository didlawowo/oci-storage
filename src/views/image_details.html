<!-- views/image_details.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
</head>

<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex items-center">
            <a href="/" class="flex items-center">
                <img src="/favicon.ico" alt="Logo" class="h-8 w-8 mr-2">
                <h1 class="text-2xl font-bold">oci storage</h1>
            </a>
            <span class="ml-4 text-blue-200">/ Docker Images / {{.Name}}:{{.Tag}}</span>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <div class="bg-white rounded-lg shadow-md p-6">
            <!-- Header -->
            <div class="mb-6 border-b pb-4">
                <div class="flex items-center gap-3 mb-2">
                    <i class="material-icons text-4xl text-purple-600">inventory_2</i>
                    <h2 class="text-2xl font-bold text-blue-600">{{.Name}}</h2>
                </div>
                <div class="flex flex-wrap gap-3 mt-3">
                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="material-icons text-sm align-middle mr-1">label</i>
                        Tag: {{.Tag}}
                    </span>
                    {{if .Image.Config}}
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="material-icons text-sm align-middle mr-1">memory</i>
                        {{.Image.Config.Architecture}}/{{.Image.Config.OS}}
                    </span>
                    {{end}}
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="material-icons text-sm align-middle mr-1">sd_storage</i>
                        <span id="imageSize">{{.Image.Size}} bytes</span>
                    </span>
                </div>
            </div>

            {{if .Image.Platforms}}
            <!-- Available Platforms (Multi-arch) -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">devices</i>
                    Available Platforms (<span id="platformCount">{{len .Image.Platforms}}</span>)
                </h3>
                <div class="flex flex-wrap gap-2" id="platformList">
                    {{range .Image.Platforms}}
                    <span class="platform-badge bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium flex items-center gap-1" data-os="{{.OS}}" data-arch="{{.Architecture}}">
                        <i class="material-icons text-sm">memory</i>
                        {{.OS}}/{{.Architecture}}{{if .Variant}}/{{.Variant}}{{end}}
                    </span>
                    {{end}}
                </div>
            </div>
            {{end}}

            <!-- Vulnerability Scan Results -->
            <div class="mb-6" id="vulnScanSection" style="display: none;">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">bug_report</i>
                    Vulnerability Scan
                    <span id="vulnScanStatus" class="px-2 py-1 rounded-full text-xs font-medium"></span>
                </h3>
                <div id="vulnScanSummary" class="flex gap-3 mb-3"></div>
                <div id="vulnScanDecision" class="mb-3 p-3 rounded-lg border"></div>
                <div id="vulnScanActions" class="mb-3"></div>
                <div id="vulnScanTable" class="max-h-64 overflow-y-auto"></div>
            </div>

            <!-- Security Insights -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">security</i>
                    Security Insights
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="securityInsights">
                    <!-- User check -->
                    <div class="security-item p-3 rounded-lg border flex items-center gap-3" id="securityUser">
                        <i class="material-icons text-2xl" id="securityUserIcon">person</i>
                        <div>
                            <div class="font-medium text-sm" id="securityUserTitle">Runtime User</div>
                            <div class="text-xs" id="securityUserValue">
                                {{if .Image.Config}}{{if .Image.Config.Config}}{{if .Image.Config.Config.User}}{{.Image.Config.Config.User}}{{else}}root (default){{end}}{{else}}Unknown{{end}}{{else}}Unknown{{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Image Age -->
                    <div class="security-item p-3 rounded-lg border flex items-center gap-3" id="securityAge">
                        <i class="material-icons text-2xl" id="securityAgeIcon">schedule</i>
                        <div>
                            <div class="font-medium text-sm">Image Age</div>
                            <div class="text-xs" id="securityAgeValue" data-created="{{if .Image.Config}}{{.Image.Config.Created}}{{end}}">
                                {{if .Image.Config}}{{.Image.Config.Created}}{{else}}Unknown{{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Exposed Ports Count -->
                    <div class="security-item p-3 rounded-lg border flex items-center gap-3" id="securityPorts">
                        <i class="material-icons text-2xl" id="securityPortsIcon">hub</i>
                        <div>
                            <div class="font-medium text-sm">Exposed Ports</div>
                            <div class="text-xs" id="securityPortsValue">
                                {{if .Image.Config}}{{if .Image.Config.Config}}{{if .Image.Config.Config.ExposedPorts}}{{len .Image.Config.Config.ExposedPorts}} port(s){{else}}None{{end}}{{else}}Unknown{{end}}{{else}}Unknown{{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Layer Count -->
                    <div class="security-item p-3 rounded-lg border flex items-center gap-3" id="securityLayers">
                        <i class="material-icons text-2xl" id="securityLayersIcon">layers</i>
                        <div>
                            <div class="font-medium text-sm">Layer Count</div>
                            <div class="text-xs" id="securityLayersValue">
                                {{if .Image.Layers}}{{len .Image.Layers}} layers{{else}}Unknown{{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Base Image Detection -->
                    <div class="security-item p-3 rounded-lg border flex items-center gap-3" id="securityBase">
                        <i class="material-icons text-2xl" id="securityBaseIcon">foundation</i>
                        <div>
                            <div class="font-medium text-sm">Base Image</div>
                            <div class="text-xs" id="securityBaseValue">Analyzing...</div>
                        </div>
                    </div>

                    <!-- Sensitive Env Vars -->
                    <div class="security-item p-3 rounded-lg border flex items-center gap-3" id="securityEnv">
                        <i class="material-icons text-2xl" id="securityEnvIcon">vpn_key</i>
                        <div>
                            <div class="font-medium text-sm">Sensitive Env Vars</div>
                            <div class="text-xs" id="securityEnvValue">Checking...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Digest -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">fingerprint</i>
                    Digest
                </h3>
                <div id="imageDigest" class="bg-gray-100 p-3 rounded-lg font-mono text-sm break-all">
                    {{.Image.Digest}}
                </div>
            </div>

            <!-- Pull Command -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">terminal</i>
                    Pull Command
                </h3>
                <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm flex justify-between items-center">
                    <code id="pullCommand">docker pull <span class="portal-host"></span>/{{.Name}}:{{.Tag}}</code>
                    <button onclick="copyPullCommand()" class="ml-4 text-gray-400 hover:text-white" title="Copy to clipboard">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>
            </div>

            {{if .Image.Config}}
            <!-- Configuration -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">settings</i>
                    Configuration
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {{if .Image.Config.Config}}
                    {{if .Image.Config.Config.Entrypoint}}
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="font-medium text-gray-700 mb-2">Entrypoint</div>
                        <code class="text-sm text-blue-600 break-all">{{range $i, $e := .Image.Config.Config.Entrypoint}}{{if $i}} {{end}}{{$e}}{{end}}</code>
                    </div>
                    {{end}}
                    {{if .Image.Config.Config.Cmd}}
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="font-medium text-gray-700 mb-2">Command</div>
                        <code class="text-sm text-blue-600 break-all">{{range $i, $e := .Image.Config.Config.Cmd}}{{if $i}} {{end}}{{$e}}{{end}}</code>
                    </div>
                    {{end}}
                    {{if .Image.Config.Config.WorkingDir}}
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="font-medium text-gray-700 mb-2">Working Directory</div>
                        <code class="text-sm text-blue-600">{{.Image.Config.Config.WorkingDir}}</code>
                    </div>
                    {{end}}
                    {{if .Image.Config.Config.User}}
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="font-medium text-gray-700 mb-2">User</div>
                        <code class="text-sm text-blue-600">{{.Image.Config.Config.User}}</code>
                    </div>
                    {{end}}
                    {{end}}
                </div>
            </div>

            {{if .Image.Config.Config}}
            {{if .Image.Config.Config.ExposedPorts}}
            <!-- Exposed Ports -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">hub</i>
                    Exposed Ports
                </h3>
                <div class="flex flex-wrap gap-2">
                    {{range $port, $_ := .Image.Config.Config.ExposedPorts}}
                    <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-mono">{{$port}}</span>
                    {{end}}
                </div>
            </div>
            {{end}}

            {{if .Image.Config.Config.Env}}
            <!-- Environment Variables -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">code</i>
                    Environment Variables
                </h3>
                <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto max-h-64">
                    <pre class="text-green-400 font-mono text-sm">{{range .Image.Config.Config.Env}}{{.}}
{{end}}</pre>
                </div>
            </div>
            {{end}}

            {{if .Image.Config.Config.Labels}}
            <!-- Labels -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">sell</i>
                    Labels
                </h3>
                <div class="bg-gray-50 rounded-lg border overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Key</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {{range $key, $value := .Image.Config.Config.Labels}}
                            <tr>
                                <td class="px-4 py-2 text-sm font-mono text-gray-900 whitespace-nowrap">{{$key}}</td>
                                <td class="px-4 py-2 text-sm font-mono text-gray-600 break-all">{{$value}}</td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
            {{end}}
            {{end}}
            {{end}}

            {{if .Image.Layers}}
            <!-- Layers -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">layers</i>
                    Layers ({{len .Image.Layers}})
                </h3>
                <div class="space-y-2">
                    {{range $i, $layer := .Image.Layers}}
                    <div class="bg-gray-50 p-3 rounded-lg border flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium">{{$i}}</span>
                            <div>
                                <div class="font-mono text-xs text-gray-500 break-all max-w-2xl">{{$layer.Digest}}</div>
                                <div class="text-xs text-gray-400 mt-1">{{$layer.MediaType}}</div>
                            </div>
                        </div>
                        <span class="layer-size text-sm text-gray-600 font-medium whitespace-nowrap ml-4" data-size="{{$layer.Size}}">{{$layer.Size}} bytes</span>
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}

            {{if .Image.Config}}
            {{if .Image.Config.History}}
            <!-- Build History -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="material-icons text-gray-600">history</i>
                    Build History
                </h3>
                <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto max-h-96">
                    <div class="space-y-2">
                        {{range $i, $h := .Image.Config.History}}
                        <div class="text-sm font-mono {{if $h.EmptyLayer}}text-gray-500{{else}}text-green-400{{end}}">
                            <span class="text-gray-500 mr-2">#{{$i}}</span>
                            {{if $h.EmptyLayer}}<span class="text-yellow-500">[empty]</span> {{end}}
                            <span class="break-all">{{$h.CreatedBy}}</span>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}
            {{end}}

            <!-- Actions -->
            <div class="flex gap-4 pt-4 border-t">
                <a href="/"
                    class="flex items-center gap-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    <i class="material-icons">arrow_back</i>
                    Back to List
                </a>
                <button onclick="deleteImage()"
                    class="flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    <i class="material-icons">delete</i>
                    Delete Image
                </button>
            </div>
        </div>
    </main>
</body>
<script>
    // Format bytes to human readable
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Format all sizes on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Format image size
        const imageSizeEl = document.getElementById('imageSize');
        if (imageSizeEl) {
            const size = parseInt(imageSizeEl.textContent);
            if (!isNaN(size)) {
                imageSizeEl.textContent = formatBytes(size);
            }
        }

        // Format layer sizes
        document.querySelectorAll('.layer-size').forEach(el => {
            const size = parseInt(el.dataset.size);
            if (!isNaN(size)) {
                el.textContent = formatBytes(size);
            }
        });

        // Set portal host in pull command
        const portalHost = window.location.host;
        document.querySelectorAll('.portal-host').forEach(el => {
            el.textContent = portalHost;
        });

        // Filter out unknown/unknown platforms and update count
        const platformList = document.getElementById('platformList');
        const platformCount = document.getElementById('platformCount');
        if (platformList) {
            const badges = platformList.querySelectorAll('.platform-badge');
            let validCount = 0;
            badges.forEach(badge => {
                if (badge.dataset.os === 'unknown' && badge.dataset.arch === 'unknown') {
                    badge.remove();
                } else {
                    validCount++;
                }
            });
            if (platformCount) {
                platformCount.textContent = validCount;
            }
        }

        // Security Insights Analysis
        analyzeSecurityInsights();

        // Load vulnerability scan if available
        loadVulnScan();
    });

    async function loadVulnScan() {
        // Get digest from the dedicated digest element
        const digestEl = document.getElementById('imageDigest');
        if (!digestEl) return;
        const fullDigest = digestEl.textContent.trim();
        if (!fullDigest.startsWith('sha256:')) return;
        const digestShort = fullDigest.replace('sha256:', '').substring(0, 64);

        try {
            const resp = await fetch(`/api/scan/report/${digestShort}`);
            if (!resp.ok) return;
            const data = await resp.json();
            const sr = data.scanResult;
            const decision = data.decision;
            if (!sr) return;

            const section = document.getElementById('vulnScanSection');
            section.style.display = 'block';

            // Status badge
            const statusEl = document.getElementById('vulnScanStatus');
            if (decision) {
                const colors = { approved: 'bg-green-100 text-green-800', pending: 'bg-yellow-100 text-yellow-800', denied: 'bg-red-100 text-red-800' };
                statusEl.className = `px-2 py-1 rounded-full text-xs font-medium ${colors[decision.status] || ''}`;
                statusEl.textContent = decision.status.toUpperCase();
            }

            // Summary badges
            document.getElementById('vulnScanSummary').innerHTML = `
                <span class="bg-red-600 text-white px-3 py-1 rounded font-bold text-sm">${sr.critical} Critical</span>
                <span class="bg-orange-500 text-white px-3 py-1 rounded font-bold text-sm">${sr.high} High</span>
                <span class="bg-yellow-500 text-white px-3 py-1 rounded font-bold text-sm">${sr.medium} Medium</span>
                <span class="bg-blue-400 text-white px-3 py-1 rounded font-bold text-sm">${sr.low} Low</span>
                <span class="text-gray-500 text-sm ml-2">Scanned: ${new Date(sr.scannedAt).toLocaleString()}</span>
            `;

            // Decision info
            if (decision) {
                document.getElementById('vulnScanDecision').innerHTML = `
                    <p class="text-sm"><strong>Decision:</strong> ${decision.status} by ${decision.decidedBy}</p>
                    <p class="text-sm text-gray-600">${decision.reason || ''}</p>
                    ${decision.expiresAt ? `<p class="text-xs text-gray-400">Expires: ${new Date(decision.expiresAt).toLocaleDateString()}</p>` : ''}
                `;
            }

            // CVE table - sort by severity (CRITICAL first)
            if (sr.vulnerabilities && sr.vulnerabilities.length > 0) {
                const sevOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3 };
                const sortedVulns = [...sr.vulnerabilities].sort((a, b) =>
                    (sevOrder[a.severity.toUpperCase()] ?? 4) - (sevOrder[b.severity.toUpperCase()] ?? 4)
                );

                let tableHtml = `<table class="w-full text-sm"><thead class="bg-gray-50"><tr>
                    <th class="px-2 py-1 text-left">CVE</th><th class="px-2 py-1 text-left">Severity</th>
                    <th class="px-2 py-1 text-left">Package</th><th class="px-2 py-1 text-left">Fixed In</th>
                </tr></thead><tbody class="divide-y">`;
                sortedVulns.slice(0, 50).forEach(v => {
                    const sevColors = { CRITICAL: 'bg-red-100 text-red-800', HIGH: 'bg-orange-100 text-orange-800', MEDIUM: 'bg-yellow-100 text-yellow-800', LOW: 'bg-blue-100 text-blue-800' };
                    const link = v.link ? `<a href="${v.link}" target="_blank" class="text-blue-600 hover:underline">${v.id}</a>` : v.id;
                    tableHtml += `<tr><td class="px-2 py-1">${link}</td><td class="px-2 py-1"><span class="px-1.5 py-0.5 rounded text-xs ${sevColors[v.severity.toUpperCase()] || ''}">${v.severity}</span></td><td class="px-2 py-1">${v.package}@${v.version}</td><td class="px-2 py-1">${v.fixedIn || '-'}</td></tr>`;
                });
                tableHtml += '</tbody></table>';
                if (sr.vulnerabilities.length > 50) tableHtml += `<p class="text-xs text-gray-400 mt-2">Showing 50 of ${sr.vulnerabilities.length} vulnerabilities</p>`;
                document.getElementById('vulnScanTable').innerHTML = tableHtml;
            }
        } catch (e) {
            // Scan not available, keep section hidden
        }
    }

    // Security color helpers
    function setSecurityStatus(elementId, status) {
        const el = document.getElementById(elementId);
        const icon = document.getElementById(elementId + 'Icon');
        if (!el) return;

        el.classList.remove('bg-red-50', 'bg-yellow-50', 'bg-green-50', 'bg-gray-50');
        el.classList.remove('border-red-200', 'border-yellow-200', 'border-green-200', 'border-gray-200');
        if (icon) {
            icon.classList.remove('text-red-500', 'text-yellow-500', 'text-green-500', 'text-gray-400');
        }

        switch(status) {
            case 'danger':
                el.classList.add('bg-red-50', 'border-red-200');
                if (icon) icon.classList.add('text-red-500');
                break;
            case 'warning':
                el.classList.add('bg-yellow-50', 'border-yellow-200');
                if (icon) icon.classList.add('text-yellow-500');
                break;
            case 'success':
                el.classList.add('bg-green-50', 'border-green-200');
                if (icon) icon.classList.add('text-green-500');
                break;
            default:
                el.classList.add('bg-gray-50', 'border-gray-200');
                if (icon) icon.classList.add('text-gray-400');
        }
    }

    function analyzeSecurityInsights() {
        // 1. User Analysis
        const userValue = document.getElementById('securityUserValue');
        if (userValue) {
            const user = userValue.textContent.trim();
            if (user === 'root (default)' || user === 'root' || user === '0') {
                setSecurityStatus('securityUser', 'warning');
            } else if (user === 'Unknown') {
                setSecurityStatus('securityUser', 'neutral');
            } else {
                setSecurityStatus('securityUser', 'success');
            }
        }

        // 2. Image Age Analysis
        const ageEl = document.getElementById('securityAgeValue');
        if (ageEl && ageEl.dataset.created) {
            const created = new Date(ageEl.dataset.created);
            const now = new Date();
            const daysDiff = Math.floor((now - created) / (1000 * 60 * 60 * 24));

            if (!isNaN(daysDiff)) {
                let ageText = '';
                if (daysDiff === 0) ageText = 'Today';
                else if (daysDiff === 1) ageText = 'Yesterday';
                else if (daysDiff < 30) ageText = daysDiff + ' days ago';
                else if (daysDiff < 365) ageText = Math.floor(daysDiff / 30) + ' months ago';
                else ageText = Math.floor(daysDiff / 365) + ' years ago';

                ageEl.textContent = ageText;

                if (daysDiff > 365) {
                    setSecurityStatus('securityAge', 'danger');
                } else if (daysDiff > 90) {
                    setSecurityStatus('securityAge', 'warning');
                } else {
                    setSecurityStatus('securityAge', 'success');
                }
            }
        }

        // 3. Exposed Ports Analysis
        const portsValue = document.getElementById('securityPortsValue');
        if (portsValue) {
            const text = portsValue.textContent.trim();
            if (text === 'None') {
                setSecurityStatus('securityPorts', 'success');
            } else {
                const match = text.match(/(\d+)/);
                if (match) {
                    const count = parseInt(match[1]);
                    if (count > 5) {
                        setSecurityStatus('securityPorts', 'warning');
                    } else {
                        setSecurityStatus('securityPorts', 'success');
                    }
                }
            }
        }

        // 4. Layer Count Analysis
        const layersValue = document.getElementById('securityLayersValue');
        if (layersValue) {
            const match = layersValue.textContent.match(/(\d+)/);
            if (match) {
                const count = parseInt(match[1]);
                if (count > 20) {
                    setSecurityStatus('securityLayers', 'warning');
                } else if (count > 10) {
                    setSecurityStatus('securityLayers', 'neutral');
                } else {
                    setSecurityStatus('securityLayers', 'success');
                }
            }
        }

        // 5. Base Image Detection (from history)
        const historyEls = document.querySelectorAll('.space-y-2 .text-sm.font-mono');
        const baseEl = document.getElementById('securityBaseValue');
        if (baseEl && historyEls.length > 0) {
            const firstCommand = historyEls[0]?.textContent || '';
            let baseImage = 'Unknown';
            let status = 'neutral';

            if (firstCommand.includes('alpine') || firstCommand.includes('Alpine')) {
                baseImage = 'Alpine Linux';
                status = 'success';
            } else if (firstCommand.includes('debian') || firstCommand.includes('Debian')) {
                baseImage = 'Debian';
                status = 'neutral';
            } else if (firstCommand.includes('ubuntu') || firstCommand.includes('Ubuntu')) {
                baseImage = 'Ubuntu';
                status = 'neutral';
            } else if (firstCommand.includes('scratch')) {
                baseImage = 'Scratch (minimal)';
                status = 'success';
            } else if (firstCommand.includes('distroless')) {
                baseImage = 'Distroless';
                status = 'success';
            } else if (firstCommand.includes('busybox')) {
                baseImage = 'BusyBox';
                status = 'success';
            } else if (firstCommand.includes('centos') || firstCommand.includes('CentOS')) {
                baseImage = 'CentOS';
                status = 'neutral';
            } else if (firstCommand.includes('fedora') || firstCommand.includes('Fedora')) {
                baseImage = 'Fedora';
                status = 'neutral';
            }

            baseEl.textContent = baseImage;
            setSecurityStatus('securityBase', status);
        }

        // 6. Sensitive Environment Variables Detection
        const envSection = document.querySelector('pre.text-green-400');
        const envEl = document.getElementById('securityEnvValue');
        if (envEl) {
            if (!envSection) {
                envEl.textContent = 'No env vars';
                setSecurityStatus('securityEnv', 'success');
            } else {
                const envText = envSection.textContent;
                const sensitivePatterns = ['PASSWORD', 'SECRET', 'TOKEN', 'API_KEY', 'PRIVATE_KEY', 'CREDENTIAL', 'AUTH'];
                const found = sensitivePatterns.filter(p => envText.toUpperCase().includes(p));

                if (found.length > 0) {
                    envEl.textContent = found.length + ' potential secret(s)';
                    setSecurityStatus('securityEnv', 'warning');
                } else {
                    envEl.textContent = 'None detected';
                    setSecurityStatus('securityEnv', 'success');
                }
            }
        }
    }

    // Copy pull command to clipboard
    function copyPullCommand() {
        const pullCommand = document.getElementById('pullCommand').textContent;
        navigator.clipboard.writeText(pullCommand).then(() => {
            // Show feedback
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            const originalText = icon.textContent;
            icon.textContent = 'check';
            setTimeout(() => { icon.textContent = originalText; }, 2000);
        });
    }

    // Delete image
    function deleteImage() {
        const name = '{{.Name}}';
        const tag = '{{.Tag}}';
        if (confirm(`Are you sure you want to delete ${name}:${tag}?`)) {
            fetch(`/image/${name}/${tag}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    window.location.href = '/';
                } else {
                    alert('Failed to delete image: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                alert('Error deleting image: ' + err);
            });
        }
    }
</script>

</html>
