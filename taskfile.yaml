version: '3'

tasks:
  default:
    cmds:
    - task --list

  run-dev:
    desc: Start dev server with hot reload
    dir: src
    cmds:
    - air

  build:
    desc: Build and push Docker image
    vars:
      COMMIT_SHA:
        sh: git rev-parse --short HEAD
    cmds:
    - docker buildx build --platform linux/amd64 -t fizzbuzz2/oci-storage:{{.COMMIT_SHA}} --push .
    - 'sed -i "" "s/tag: .*/tag: \"{{.COMMIT_SHA}}\"/" helm/values.yaml'
    - echo "Pushed fizzbuzz2/oci-storage:{{.COMMIT_SHA}} and updated helm/values.yaml"

  start:
    desc: Start Docker container
    cmds:
    - docker compose up -d

  stop:
    desc: Stop Docker container
    cmds:
    - docker compose down

  helm-template:
    desc: Template the helmchart
    dir: helm
    cmds:
    - helm template . --debug -f values/home/values.yaml > rendered.yaml

  test-unit:
    desc: Run Go unit tests
    dir: src
    cmds:
    - go test ./pkg/... -v

  test-e2e:
    desc: Run full E2E tests (OCI protocol, HTTP API, proxy, auth, backup)
    dir: tests
    cmds:
    - ./test-e2e.sh

  create-auth-secret:
    desc: Create Kubernetes auth secret
    cmds:
    - kubectl create secret generic oci-storage-auth --from-literal=HELM_USERS="admin:secret123,dev:devpass,readonly:readpass" --namespace=kube-infra --dry-run=client -o yaml | kubectl apply -f -

  create-backup-secret:
    desc: Create Kubernetes backup secret (AWS)
    cmds:
    - kubectl create secret generic oci-storage-backup --from-literal=BACKUP_ENABLED="true" --from-literal=BACKUP_PROVIDER="aws" --from-literal=AWS_BUCKET="oci-storage-backup" --from-literal=AWS_REGION="eu-west-1" --from-literal=AWS_ACCESS_KEY_ID="YOUR_ACCESS_KEY" --from-literal=AWS_SECRET_ACCESS_KEY="YOUR_SECRET_KEY" --namespace=kube-infra --dry-run=client -o yaml | kubectl apply -f -
