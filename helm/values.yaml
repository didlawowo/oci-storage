fullnameOverride: oci-storage
namespace: oci-storage
podAnnotations:
  oci-portal-skip: "true"
image:
  repository: fizzbuzz2/oci-storage
  tag: "e5e7124"
  pullPolicy: "Always"
  pullSecrets: []
strategy:
  type: Recreate
replicas: 1
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80
pdb:
  enabled: true
  maxUnavailable: 1
serviceAccount:
  create: true
  name: oci-storage
  annotations: {}
nodeSelector: {}
tolerations: []
affinity: {}
initContainers:
- name: init-data-dir
  image: busybox
  command: [ "sh", "-c", "mkdir -p /app/data/temp /app/data/blobs /app/data/manifests /app/data/charts &&  chown -R 1000:1000 /app/data" ]
  volumeMounts:
  - name: data-volume
    mountPath: /app/data
resources:
  limits:
    cpu: 300m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
# volumes 
persistentVolumesClaims:
- name: oci-storage-data
  accessModes:
  - ReadWriteOnce
  storageClassName: longhorn
  size: 30Gi
application:
  ports:
  - name: http
    containerPort: 3030
    protocol: TCP
  containerName: oci-storage
  command: []
  args: []
service:
  name: oci-storage
  port: 80
  targetPort: 3030
  type: ClusterIP
  portName: http
secrets:
  dotenv: []
  #   - name: backup
  #     path: values/home/secrets/secrets.env
  files:
  - name: auth
    path: values/home/secrets/auth.yaml
volumeMounts:
- name: config-volume
  mountPath: /app/config # RÃ©pertoire entier
  readOnly: true
- name: data-volume
  mountPath: /app/data
volumes:
- name: config-volume
  projected:
    # ðŸŽ¯ Combine plusieurs sources
    sources:
    - configMap:
        name: oci-storage-config
        items:
        - key: config.yaml
          path: config.yaml # Sera /app/config/config.yaml
    - secret:
        name: oci-storage-auth
        items:
        - key: auth.yaml
          path: auth.yaml
- name: data-volume
  persistentVolumeClaim:
    claimName: oci-storage-data
# probes
livenessProbe:
  httpGet:
    scheme: HTTP
    path: /health
    port: 3030
  initialDelaySeconds: 2
  periodSeconds: 10
  timeoutSeconds: 1
  successThreshold: 1
  failureThreshold: 3
readinessProbe:
  httpGet:
    scheme: HTTP
    path: /health
    port: 3030
  initialDelaySeconds: 2
  periodSeconds: 5
  timeoutSeconds: 1
  successThreshold: 1
  failureThreshold: 3
ingress:
  host: oci-storage.example.com
  tls:
    enabled: true
    secretName: ""
  ingressClassName: traefik
env:
- name: ENV
  value: production
# Configuration via variables d'environnement
- name: SERVER_PORT
  value: "3030"
- name: LOG_LEVEL
  value: "info"
# Auth configuration - Option 1: Variable unique avec liste
# Temporaire pour test - Ã  remplacer par secret en production
- name: HELM_USERS
  # Auth configuration - Choisir UNE des 3 options :

  value: "admin:secret123,dev:devpass,readonly:readpass"
# Backup configuration (si activÃ©)
# - name: BACKUP_ENABLED
#   value: "true"
# - name: BACKUP_PROVIDER
#   value: "aws"  # ou "gcp" ou "azure"

# AWS config
# - name: AWS_BUCKET
#   value: "oci-storage-backup"
# - name: AWS_REGION
#   value: "eu-west-1"
# - name: AWS_ACCESS_KEY_ID
#   value: "your-access-key"
# - name: AWS_SECRET_ACCESS_KEY
#   value: "your-secret-key"

# GCP config  
# - name: GCP_BUCKET
#   value: "oci-storage-backup"
# - name: GCP_PROJECT_ID
#   value: "your-project-id"
# - name: GCP_CREDENTIALS_FILE
#   value: "/path/to/credentials.json"

# Azure config
# - name: AZURE_STORAGE_ACCOUNT
#   value: "helmportalbackup"
# - name: AZURE_CONTAINER
#   value: "backup"
# - name: AZURE_STORAGE_ACCOUNT_KEY
#   value: "your-storage-key"

# Registry credentials for proxy (loaded from secrets)
- name: GHCR_USERNAME
  valueFrom:
    secretKeyRef:
      name: ghcr-credentials
      key: username
      optional: true
- name: GHCR_PASSWORD
  valueFrom:
    secretKeyRef:
      name: ghcr-credentials
      key: password
      optional: true
- name: DOCKERHUB_USERNAME
  valueFrom:
    secretKeyRef:
      name: dockerhub-credentials
      key: username
      optional: true
- name: DOCKERHUB_PASSWORD
  valueFrom:
    secretKeyRef:
      name: dockerhub-credentials
      key: password
      optional: true
envFrom: []
# Secret pour les credentials d'authentification (activer aprÃ¨s crÃ©ation du secret)
# - secretRef:
#     name: oci-storage-auth
# Secret pour les credentials de backup (optionnel)
# - secretRef:
#     name: oci-storage-backup
# External Secrets (Pulumi ESC)
externalSecrets:
  enabled: false
  secrets: []
# Kyverno policy for image rewriting
kyverno:
  enabled: true
  # The hostname of the OCI portal (without protocol)
  # e.g., "oci-storage.example.com" or "oci-storage:3030"
  portalHost: "oci-storage.dc-tech.work"

config:
  server:
    port: 3030
  storage:
    path: "data"
  backup:
    enabled: false
    provider: "" # "aws" ou "gcp"
    # gcp:
    #   bucket: "oci-storage-backup"
    #   projectID: "dc-consulting-home"
    # aws:
    #   bucket: "oci-storage-backup"
    #   region: "eu-west-1"
  logging:
    level: "info"
    format: "text"
  # Docker registry proxy/cache configuration
  proxy:
    enabled: true
    cache:
      maxSizeGB: 10
    registries:
    - name: "docker.io"
      url: "https://registry-1.docker.io"
      default: true
    - name: "ghcr.io"
      url: "https://ghcr.io"
      # Credentials loaded from environment variables GHCR_USERNAME and GHCR_PASSWORD
    - name: "gcr.io"
      url: "https://gcr.io"
    - name: "eu.gcr.io"
      url: "https://eu.gcr.io"
    - name: "us.gcr.io"
      url: "https://us.gcr.io"
    - name: "asia.gcr.io"
      url: "https://asia.gcr.io"
    - name: "quay.io"
      url: "https://quay.io"
